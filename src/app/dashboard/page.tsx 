'use client';
import { useEffect, useState } from 'react';
import { useRouter } from 'next/navigation';

async function api(url: string, opt: RequestInit = {}) {
  const token = localStorage.getItem('token');
  const headers = { ...(opt.headers || {}), authorization: `Bearer ${token}` } as HeadersInit;
  return fetch(url, { ...opt, headers });
}

export default function Dashboard() {
  const [balance, setBal] = useState<number>();
  const [reels, setReels] = useState<string[]>();
  const [wager, setW] = useState(10);
  const r = useRouter();
  useEffect(() => {
    api('/api/balance').then(async res => {
      if (res.status === 401) return r.push('/login');
      const d = await res.json();
      setBal(d.balance);
    });
  }, []);
  const spin = async () => {
    const res = await api('/api/spin', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ wager }),
    });
    const d = await res.json();
    if (!res.ok) return alert(d.error);
    setReels(d.reels);
    setBal(d.balance);
  };
  return (
    <div className="max-w-md mx-auto flex flex-col gap-4">
      <h1 className="text-2xl font-bold">Balance: {balance}</h1>
      <div className="flex gap-2">
        <input className="border p-2 flex-1" type="number" min={1} value={wager} onChange={e => setW(Number(e.target.value))} />
        <button className="bg-purple-700 text-white p-2" onClick={spin}>Spin</button>
      </div>
      {reels && <div className="text-4xl text-center">{reels.join(' ')}</div>}
    </div>
  );
}
